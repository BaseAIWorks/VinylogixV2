rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to make rules more readable
    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.role == 'superadmin';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isMaster() {
      return isSignedIn() && request.auth.token.role == 'master';
    }

    function isWorker() {
      return isSignedIn() && request.auth.token.role == 'worker';
    }

    function isOperator() {
      return isMaster() || isWorker();
    }
    
    function isMasterOf(distributorId) {
      return isMaster() && request.auth.token.distributorId == distributorId;
    }

    function isWorkerOf(distributorId) {
      return isWorker() && request.auth.token.distributorId == distributorId;
    }

    function isOperatorOf(distributorId) {
        return isMasterOf(distributorId) || isWorkerOf(distributorId);
    }
    
    function isClientOf(distributorId) {
      return isSignedIn() && request.auth.token.accessibleDistributorIds.hasAny([distributorId]);
    }

    // SECURITY: Check if sensitive fields are being modified
    // These fields control permissions and should NEVER be self-modifiable
    function sensitiveFieldsUnchanged() {
      let before = resource.data;
      let after = request.resource.data;

      // Check that role hasn't changed (or wasn't set if it didn't exist)
      let roleUnchanged = (!('role' in before) && !('role' in after)) ||
                          (('role' in before) && ('role' in after) && before.role == after.role);

      // Check that distributorId hasn't changed
      let distributorUnchanged = (!('distributorId' in before) && !('distributorId' in after)) ||
                                  (('distributorId' in before) && ('distributorId' in after) && before.distributorId == after.distributorId);

      // Check that accessibleDistributorIds hasn't changed
      let accessUnchanged = (!('accessibleDistributorIds' in before) && !('accessibleDistributorIds' in after)) ||
                            (('accessibleDistributorIds' in before) && ('accessibleDistributorIds' in after) && before.accessibleDistributorIds == after.accessibleDistributorIds);

      return roleUnchanged && distributorUnchanged && accessUnchanged;
    }

    // Check if ONLY role-related fields are being modified (for masters updating their team)
    function noRoleEscalation() {
      let after = request.resource.data;
      // Masters cannot set role to 'master' or 'superadmin' for anyone
      return !('role' in after) || (after.role != 'master' && after.role != 'superadmin');
    }

    // ==================================================================
    // Collections
    // ==================================================================

    match /users/{userId} {
      // Anyone can read their own user document.
      // A master user can read any user document within their own distributorship.
      // A superadmin can read any user document.
      allow read: if isSuperAdmin() || isOwner(userId) || (isMaster() && resource.data.distributorId == request.auth.token.distributorId);

      // A user can create their own document (on signup).
      // On create, users cannot set themselves as master or superadmin.
      allow create: if isOwner(userId) &&
                      (!('role' in request.resource.data) ||
                       (request.resource.data.role != 'master' && request.resource.data.role != 'superadmin'));

      // SECURITY: Field-level restrictions on updates
      // - Users can update their own document BUT cannot change sensitive fields (role, distributorId, accessibleDistributorIds)
      // - Masters can update users in their distributor BUT cannot escalate to master/superadmin
      // - Superadmins can update anything
      allow update: if isSuperAdmin() ||
                      (isOwner(userId) && sensitiveFieldsUnchanged()) ||
                      (isMaster() && resource.data.distributorId == request.auth.token.distributorId && noRoleEscalation());

      // A master or superadmin can delete a user document.
      allow delete: if isSuperAdmin() || (isMaster() && resource.data.distributorId == request.auth.token.distributorId);
    }

    match /distributors/{distributorId} {
      // Superadmins can manage all distributors.
      allow read, write, delete: if isSuperAdmin();

      // Operators can read their own distributor document.
      // Clients can read the document of distributors they have access to.
      allow read: if isSignedIn() && (isOperatorOf(distributorId) || isClientOf(distributorId));

      // Only the master of a distributor can update it.
      allow update: if isMasterOf(distributorId);

      // Suppliers subcollection under each distributor
      match /suppliers/{supplierId} {
        // Superadmins can manage all suppliers
        allow read, write, delete: if isSuperAdmin();

        // Operators can manage suppliers for their distributor
        allow read, write, delete: if isOperatorOf(distributorId);

        // Allow creating suppliers if user is an operator of this distributor
        allow create: if isOperatorOf(distributorId);
      }
    }

    match /vinylRecords/{recordId} {
      // Anyone signed in can create a record (for their own collection or inventory).
      allow create: if isSignedIn()
                && request.resource.data.ownerUid == request.auth.uid // Must claim self-ownership
                && (
                     // If it's a personal record, ensure it's not trying to be an inventory item for a distributor
                     (request.resource.data.isInventoryItem == false && !exists(request.resource.data.distributorId)) ||
                     // If it's an inventory item, the user must be an operator of the claimed distributor
                     (request.resource.data.isInventoryItem == true && isOperatorOf(request.resource.data.distributorId))
                   );

      // Read permissions are more complex:
      // 1. Superadmins can read anything.
      // 2. You can read your own personal records (that are not inventory items).
      // 3. Operators can read any record belonging to their distributor.
      // 4. Clients can read any inventory item from a distributor they have access to.
      allow read: if isSuperAdmin() ||
                   (isOwner(resource.data.ownerUid) && resource.data.isInventoryItem == false) ||
                   isOperatorOf(resource.data.distributorId) ||
                   (resource.data.isInventoryItem == true && isClientOf(resource.data.distributorId));

      // Update permissions:
      // 1. Superadmins can update anything.
      // 2. You can update your own personal records.
      // 3. Operators can update any record belonging to their distributor.
      allow update: if isSuperAdmin() || isOwner(resource.data.ownerUid) || isOperatorOf(resource.data.distributorId);

      // Delete permissions:
      // 1. Superadmins can delete anything.
      // 2. You can delete your own personal records.
      // 3. Operators can delete any record belonging to their distributor.
      allow delete: if isSuperAdmin() || isOwner(resource.data.ownerUid) || isOperatorOf(resource.data.distributorId);
    }
    
    match /suppliers/{supplierId} {
        // Superadmins can manage all suppliers
        allow read, write, delete: if isSuperAdmin();

        // Allow operators to manage suppliers for their distributor
        allow read, write, delete: if isOperatorOf(resource.data.distributorId);

        // Allow creating suppliers if user is an operator and the distributorId matches their token
        allow create: if isOperator() && request.resource.data.distributorId == request.auth.token.distributorId;
    }

    match /orders/{orderId} {
        // Superadmins can manage all orders
        allow read, write, delete: if isSuperAdmin();

        allow create: if isSignedIn();
        allow read, update: if isOperatorOf(resource.data.distributorId) || isOwner(resource.data.viewerId);
    }

    match /notifications/{notificationId} {
        // Superadmins can manage all notifications
        allow read, write, delete: if isSuperAdmin();

        allow read, write: if isOperatorOf(resource.data.distributorId);
    }

    match /settings/{docId} {
      // Superadmins can manage all settings.
      allow read, write: if isSuperAdmin();
      // Branding settings are public (company name, logo) for the login page
      // Other settings require authentication
      allow read: if docId == 'branding' || isSignedIn();
    }

    match /changelog/{entryId} {
      // Superadmins can manage changelog entries.
      allow read, write, delete: if isSuperAdmin();
      // All authenticated users can read changelog entries.
      allow read: if isSignedIn();
    }
  }
}
